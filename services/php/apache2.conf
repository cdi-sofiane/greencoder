Listen 80

LoadModule mpm_prefork_module /usr/lib/apache2/modules/mod_mpm_prefork.so
LoadModule authn_file_module /usr/lib/apache2/modules/mod_authn_file.so
LoadModule authn_core_module /usr/lib/apache2/modules/mod_authn_core.so
LoadModule authz_host_module /usr/lib/apache2/modules/mod_authz_host.so
LoadModule authz_groupfile_module /usr/lib/apache2/modules/mod_authz_groupfile.so
LoadModule authz_user_module /usr/lib/apache2/modules/mod_authz_user.so
LoadModule authz_core_module /usr/lib/apache2/modules/mod_authz_core.so
LoadModule dir_module /usr/lib/apache2/modules/mod_dir.so
LoadModule reqtimeout_module /usr/lib/apache2/modules/mod_reqtimeout.so
LoadModule mime_module /usr/lib/apache2/modules/mod_mime.so
LoadModule env_module /usr/lib/apache2/modules/mod_env.so
LoadModule expires_module /usr/lib/apache2/modules/mod_expires.so
LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so
LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so
LoadModule deflate_module /usr/lib/apache2/modules/mod_deflate.so
LoadModule php7_module /usr/lib/apache2/modules/libphp7.so

# Core parameters
ServerAdmin root@buyin.pro
Mutex file:${APACHE_LOCK_DIR} default
PidFile ${APACHE_PID_FILE}
Timeout 300
HostnameLookups Off

# User
User ${APACHE_RUN_USER}
Group ${APACHE_RUN_GROUP}

<IfModule mpm_prefork_module>
    StartServers             5
    MinSpareServers          5
    MaxSpareServers          10
    MaxRequestWorkers        150
    MaxConnectionsPerChild   0
</IfModule>

<IfModule mod_dir.c>
    DirectoryIndex index.html index.cgi index.pl index.php index.xhtml index.htm
</IfModule>

<IfModule mod_deflate.c>
    <IfModule mod_filter.c>
        # these are known to be safe with MSIE 6
        AddOutputFilterByType DEFLATE text/html text/plain text/xml

        # everything else may cause problems with MSIE 6
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/x-javascript application/javascript application/ecmascript
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/xml
    </IfModule>
</IfModule>

<IfModule reqtimeout_module>
    RequestReadTimeout header=20-40,minrate=500

    # Wait max 10 seconds for the first byte of the request body (if any)
    # From then, require a minimum data rate of 500 bytes/s
    RequestReadTimeout body=10,minrate=500
</IfModule>

<Directory />
    AllowOverride none
    Require all denied
</Directory>

ErrorLog /proc/self/fd/2
LogLevel warn

<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common
    CustomLog /proc/self/fd/1 common
</IfModule>

<Directory "/usr/local/apache2/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>

<IfModule headers_module>
    RequestHeader unset Proxy early
</IfModule>

<IfModule mime_module>
    TypesConfig /etc/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
</IfModule>

<IfModule expires_module>
    ExpiresActive On
    ExpiresByType image/gif "access 1 month"
    ExpiresByType image/jpg "access 1 month"
    ExpiresByType image/jpeg "access 1 month"
    ExpiresByType image/png "access 1 month"
</IfModule>

AccessFileName .htaccess

<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>


#
# Buyin security requirements
# Comes from DT/Orange pentest suggestions and ORange ROS file
#
ServerSignature Off
ServerTokens ProductOnly
TraceEnable off
RewriteEngine On
RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
RewriteRule .* - [F]
#Header set Content-Security-Policy "default-src 'self'; script-src 'self' *.buyin.pro 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' *.buyin.pro data:; font-src 'self' data:;"
Header set X-Content-Type-Options nosniff
Header set X-XSS-Protection "1; mode=block"
Header always append X-Frame-Options DENY
Header set Strict-Transport-Security "max-age=31536000" env=HTTPS
Header edit Set-Cookie ^(.*)$ $1;HttpOnly;Secure;SameSite=Lax
Header set Referrer-Policy: no-referrer-when-downgrade
KeepAlive On
KeepAliveTimeout 5
MaxKeepAliveRequests 100
<Location />
    Require all granted
    <LimitExcept HEAD POST GET PUT>
        Require all denied
    </LimitExcept>
</Location>

# Additions to security requirements (forbids access to configuration or development files)
<FilesMatch "(^\.ht|~$|\.bak$|\.env$|\.BAK$|\.old$|\.phar$|\.yml$|\.md$|\.dist$)">
    Require all denied
</FilesMatch>
<DirectoryMatch "(/CVS/|.svn|.git|.idea)">
    Require all denied
</DirectoryMatch>

<FilesMatch \.php$>
        SetHandler application/x-httpd-php
</FilesMatch>

DirectoryIndex disabled
DirectoryIndex index.php index.html

<Directory /var/www/>
        Options -Indexes
        AllowOverride All
</Directory>

# App's Virtual Host
<VirtualHost *:80>
    DocumentRoot /var/www/html/web

    # Relax Apache security settings
    <Directory /var/www/html/web/>
        Options -MultiViews
        Require all granted
        AllowOverride all
    </Directory>
</VirtualHost>
